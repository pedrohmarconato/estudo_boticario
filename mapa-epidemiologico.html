<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualização COVID-19 - Grafo Epidemiológico Brasil</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        :root {
            --azul-marinho: #011E38;
            --off-white: #F5F1EB;
            --azul-royal: #264FEC;
            --salmao: #FFBC82;
            --rosa-pink: #FF69B4;
            --font-primary: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --cluster-1: #FF6B6B;
            --cluster-2: #4ECDC4;
            --cluster-3: #45B7D1;
            --cluster-4: #96CEB4;
            --cluster-5: #FFEAA7;
            --dark-bg: #0a0a0a;
            --sidebar-bg: #1a1a1a;
            --control-bg: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--azul-marinho);
            color: var(--off-white);
            height: 100vh;
            overflow: hidden;
        }

        /* Layout Principal */
        .app-container {
            height: 100vh;
            position: relative;
        }

        /* Header - Estilo Consultoria idêntico ao nova-etapa */
        .header {
            background: rgba(245, 241, 235, 0.98);
            backdrop-filter: blur(10px);
            padding: 15px 40px;
            border-bottom: 3px solid var(--salmao);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* Botões laterais de navegação */
        .nav-lateral {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            z-index: 200;
            background: var(--azul-royal);
            color: white;
            border: none;
            padding: 20px 16px;
            font-size: 28px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(38, 79, 236, 0.4);
        }

        .nav-lateral:hover {
            background: var(--azul-marinho);
            transform: translateY(-50%) scale(1.05);
        }

        .nav-lateral.prev {
            left: 20px;
            border-radius: 0 12px 12px 0;
        }

        .nav-lateral.next {
            right: 20px;
            border-radius: 12px 0 0 12px;
        }

        .nav-lateral.disabled {
            background: var(--cinza-medio);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .nav-lateral.disabled:hover {
            background: var(--cinza-medio);
            transform: translateY(-50%);
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--azul-marinho);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: var(--cinza-medio);
        }

        /* Legenda Lateral - Painel Retrátil */
        .legend-panel {
            position: fixed;
            right: 0;
            bottom: 140px;
            transform: translateX(calc(100% - 35px));
            width: 280px;
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 12px 0 0 12px;
            padding: 15px;
            padding-left: 45px;
            z-index: 1001;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: -2px 0px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .legend-panel.open {
            transform: translateX(0);
            background: rgba(26, 26, 26, 0.55);
            box-shadow: -4px 0px 18px rgba(0,0,0,0.2);
        }

        .legend-toggle-handle {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 35px;
            height: 60px;
            background: rgba(255, 188, 130, 0.9);
            cursor: pointer;
            border-radius: 6px 0 0 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 10px;
            font-weight: 400;
            color: var(--azul-marinho);
            letter-spacing: 0.3px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .legend-toggle-handle:hover {
            background: rgba(255, 188, 130, 0.6);
            color: var(--azul-marinho);
            font-weight: 500;
        }

        .legend-section {
            margin-bottom: 20px;
        }

        .legend-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--salmao);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 188, 130, 0.3);
            padding-bottom: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 11px;
            color: var(--off-white);
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
            position: relative;
        }

        .legend-pulse {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: relative;
            animation: legendPulse 2s infinite;
        }

        @keyframes legendPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .legend-particle {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: relative;
            animation: particleGlow 1.5s ease-in-out infinite alternate;
        }

        .legend-description {
            flex: 1;
            line-height: 1.3;
        }


        /* Executive Report Modal - Estilo Bain/McKinsey */
        .executive-report {
            position: fixed;
            left: 10%;
            top: 55%;
            transform: translateY(-50%);
            width: 600px;
            background: none;
            color: var(--off-white);
            z-index: 900;
            padding: 0;
        }

        .report-modal {
            background: rgba(1, 30, 56, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 188, 130, 0.3);
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .report-header {
            text-align: left;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--salmao);
            padding-bottom: 20px;
        }

        .report-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--off-white);
            margin-bottom: 10px;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .report-subtitle {
            font-size: 18px;
            color: var(--salmao);
            font-weight: 500;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .report-context {
            font-size: 15px;
            color: rgba(245, 241, 235, 0.7);
            font-weight: 400;
        }

        .report-content {
            line-height: 1.5;
            font-size: 13px;
            color: rgba(245, 241, 235, 0.85);
        }

        .report-content p strong {
            color: var(--salmao);
            font-weight: 600;
            font-size: 14px;
        }

        .key-insight {
            background: rgba(255, 188, 130, 0.15);
            border-left: 4px solid var(--salmao);
            padding: 16px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
            box-shadow: 0 2px 8px rgba(255, 188, 130, 0.1);
        }

        .insight-highlight {
            font-weight: 700;
            color: var(--salmao);
            margin-bottom: 10px;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .business-conclusion {
            margin-top: 24px;
            padding: 20px;
            border: 2px solid var(--salmao);
            border-radius: 6px;
            background: rgba(255, 188, 130, 0.08);
            color: var(--off-white);
        }

        .business-conclusion strong {
            display: block;
            color: var(--salmao);
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Botão Análise de Estabelecimentos */
        .next-analysis-button {
            position: fixed;
            right: 30px;
            bottom: 30px;
            background: linear-gradient(135deg, var(--salmao) 0%, var(--rosa-pink) 100%);
            color: var(--azul-marinho);
            padding: 15px 25px;
            border-radius: 50px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(255, 188, 130, 0.4);
            z-index: 999;
            animation: slideInRight 0.8s ease-out 1s both, pulse 3s infinite 2s;
        }

        .next-analysis-button:hover {
            transform: translateX(-10px) scale(1.05);
            box-shadow: 0 6px 30px rgba(255, 188, 130, 0.6);
        }

        .button-icon {
            font-size: 20px;
        }

        .button-arrow {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .next-analysis-button:hover .button-arrow {
            transform: translateX(5px);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Main Visualization Area */
        .main-viz {
            position: absolute;
            top: 60px;
            left: 150px;
            right: 0;
            bottom: 0;
            overflow: hidden;
            width: calc(100vw - 150px);
            height: calc(100vh - 60px);
        }

        #map-container {
            width: calc(100vw - 150px);
            height: 100%;
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(38,79,236,0.07) 0%, rgba(1,30,56,0.95) 100%);
            border-radius: 0;
            margin: 0;
            z-index: 1;
        }

        /* SVG Styles */
        .map-group {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }
        
        .brazil-state {
            stroke: #F5F1EB;
            stroke-width: 0.8;
            /* fill é controlado pelo D3.js, não pelo CSS */
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            opacity: 0.7;
        }

        .brazil-state:hover {
            opacity: 1;
            stroke: var(--salmao);
            stroke-width: 2;
            filter: brightness(1.3);
        }
        
        .brazil-state.highlighted {
            opacity: 1;
            stroke: var(--salmao);
            stroke-width: 3;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                filter: drop-shadow(0 0 5px rgba(255, 188, 130, 0.4));
            }
            to {
                filter: drop-shadow(0 0 15px rgba(255, 188, 130, 0.8));
            }
        }

        .state-node {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            stroke-width: 2;
            stroke: #fff;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .state-node:hover {
            transform: scale(1.3);
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
            stroke-width: 3;
        }

        .state-edge {
            stroke-opacity: 0;
            transition: all 0.3s ease;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
        }

        .state-edge.animated {
            animation: connectionGrowth 2s ease-out forwards;
        }

        .state-edge.strong-correlation {
            stroke: #00D4FF;
            filter: drop-shadow(0 0 6px #00D4FF);
            stroke-width: 4px;
        }

        .state-edge.medium-correlation {
            stroke: #FFD700;
            filter: drop-shadow(0 0 4px #FFD700);
            stroke-width: 3px;
        }

        .state-edge.weak-correlation {
            stroke: #FF6B6B;
            filter: drop-shadow(0 0 3px #FF6B6B);
            stroke-width: 2px;
        }

        .state-edge:hover {
            stroke-opacity: 1;
            stroke-width: 4;
            filter: brightness(1.5);
        }

        .state-edge.highlighted {
            stroke-opacity: 1;
            stroke-width: 4;
            animation: epidemiologicalPulse 1.5s infinite;
        }

        @keyframes connectionGrowth {
            0% { 
                stroke-dashoffset: 1000; 
                stroke-opacity: 0; 
            }
            50% { 
                stroke-opacity: 0.8; 
            }
            100% { 
                stroke-dashoffset: 0; 
                stroke-opacity: 0.7; 
            }
        }

        @keyframes epidemiologicalPulse {
            0%, 100% { 
                stroke-opacity: 0.7; 
                stroke-width: 2;
                filter: drop-shadow(0 0 2px currentColor);
            }
            50% { 
                stroke-opacity: 1; 
                stroke-width: 6;
                filter: drop-shadow(0 0 8px currentColor);
            }
        }

        /* Pulsos epidemiológicos simples */
        .epidemic-pulse {
            fill: none;
            stroke: #FFBC82;
            stroke-width: 2;
            stroke-opacity: 0;
            animation: pulseWave 2s ease-out;
        }

        @keyframes pulseWave {
            0% {
                r: 5;
                stroke-opacity: 0.8;
                stroke-width: 3;
            }
            100% {
                r: 50;
                stroke-opacity: 0;
                stroke-width: 1;
            }
        }


        /* Partículas viajantes */
        .traveling-particle {
            fill: #00D4FF;
            r: 2;
            opacity: 0.8;
            filter: drop-shadow(0 0 3px #00D4FF);
        }

        .particle-strong {
            fill: #00D4FF;
            filter: drop-shadow(0 0 4px #00D4FF);
            animation: particleGlow 1s ease-in-out infinite alternate;
        }

        .particle-medium {
            fill: #FFD700;
            filter: drop-shadow(0 0 3px #FFD700);
        }

        .particle-weak {
            fill: #FF6B6B;
            filter: drop-shadow(0 0 2px #FF6B6B);
        }

        @keyframes particleGlow {
            from { opacity: 0.6; }
            to { opacity: 1; }
        }

        /* Timeline Controls - Painel Lateral Retrátil */
        .timeline-controls {
            position: fixed;
            right: 0;
            bottom: 40px;
            transform: translateX(calc(100% - 35px));
            width: 280px;
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 12px 0 0 12px;
            padding: 15px;
            padding-left: 45px;
            z-index: 1001;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: -2px 0px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .timeline-controls.open {
            transform: translateX(0);
            background: rgba(26, 26, 26, 0.55);
            box-shadow: -4px 0px 18px rgba(0,0,0,0.2);
        }

        .timeline-toggle-handle {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 35px;
            height: 60px;
            background: rgba(255, 188, 130, 0.9);
            cursor: pointer;
            border-radius: 6px 0 0 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 10px;
            font-weight: 400;
            color: var(--azul-marinho);
            letter-spacing: 0.3px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .timeline-toggle-handle:hover {
            background: rgba(255, 188, 130, 0.6);
            color: var(--azul-marinho);
            font-weight: 500;
        }

        .timeline-date {
            font-size: 14px;
            font-weight: 600;
            color: var(--salmao);
            min-width: 70px;
            text-align: center;
        }

        .timeline-slider-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin: 0 15px;
        }

        .timeline-slider {
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, var(--azul-marinho) 0%, var(--salmao) 50%, var(--rosa-pink) 100%);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeline-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--off-white);
            border: 2px solid var(--salmao);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 188, 130, 0.4);
            transition: all 0.3s ease;
        }

        .timeline-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(255, 188, 130, 0.6);
        }

        .timeline-marks {
            display: flex;
            justify-content: space-between;
            padding: 0 8px;
        }

        .timeline-mark {
            font-size: 9px;
            color: var(--off-white);
            opacity: 0.6;
            text-align: center;
            min-width: 24px;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .control-btn {
            background: var(--azul-royal);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 70px;
            justify-content: center;
        }

        .control-btn:hover {
            background: var(--salmao);
            transform: translateY(-1px);
        }

        .control-btn.playing {
            background: var(--rosa-pink);
        }

        .speed-selector {
            background: var(--azul-marinho);
            color: var(--off-white);
            border: 1px solid var(--salmao);
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 10px;
            cursor: pointer;
            min-width: 50px;
        }

        /* Timeline Stats - Versão Compacta integrada */
        .timeline-stats {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 10px;
            color: var(--off-white);
            opacity: 0.8;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            color: var(--salmao);
            font-weight: 600;
        }


        /* Period Info Panel - Centralizado horizontalmente e um pouco abaixo do centro */
        .period-info {
            position: fixed;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 188, 130, 0.6);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            padding: 28px 32px 22px 32px;
            min-width: 280px;
            max-width: 320px;
            z-index: 1003;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s ease;
            font-size: 16px;
        }

        .period-info.show {
            transform: translate(-50%, -50%);
            opacity: 1;
        }

        .period-info:hover {
            background: rgba(0, 0, 0, 0.75);
            border-color: var(--salmao);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .period-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--salmao);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
        }

        .period-icon {
            font-size: 16px;
        }

        .period-bullets {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .period-bullet {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 6px;
            font-size: 11px;
            line-height: 1.4;
            color: var(--off-white);
            opacity: 0;
            transform: translateX(-10px);
            animation: bulletSlide 0.3s ease forwards;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .period-bullet:nth-child(1) { animation-delay: 0.1s; }
        .period-bullet:nth-child(2) { animation-delay: 0.2s; }
        .period-bullet:nth-child(3) { animation-delay: 0.3s; }
        .period-bullet:nth-child(4) { animation-delay: 0.4s; }

        @keyframes bulletSlide {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .bullet-icon {
            color: var(--salmao);
            font-size: 8px;
            margin-top: 4px;
            flex-shrink: 0;
        }

        .bullet-text {
            flex: 1;
        }

        .period-intensity {
            background: linear-gradient(90deg, var(--azul-royal) 0%, var(--salmao) 100%);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            display: inline-block;
            margin-left: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: var(--off-white);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            border: 1px solid var(--salmao);
            backdrop-filter: blur(10px);
            z-index: 5;
            max-width: 250px;
        }

        .tooltip-title {
            font-weight: 600;
            color: var(--salmao);
            margin-bottom: 6px;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }

        /* Footer removido para maximizar espaço do mapa */

        /* Loading Spinner */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #444;
            border-top: 3px solid var(--salmao);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .legend-panel {
                width: 280px;
                max-height: 60vh;
            }
            
            .timeline-controls {
                width: 250px;
            }
        }
    .legend-overlay {
    display: none;
}

/* Garante que o botão de abrir legenda fique acima do overlay */
.legend-toggle-handle {
    position: fixed;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1100;
    width: 35px;
    height: 60px;
    background: rgba(255, 188, 130, 0.9);
    cursor: pointer;
    border-radius: 0 6px 6px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    font-size: 10px;
    font-weight: 400;
    color: var(--azul-marinho);
    letter-spacing: 0.3px;
    text-transform: uppercase;
    transition: all 0.3s ease;
    box-shadow: 2px 0px 8px rgba(0,0,0,0.08);
}

.legend-toggle-handle:hover {
    background: rgba(255, 188, 130, 0.6);
    color: var(--azul-marinho);
    font-weight: 500;
}

@media (max-width: 768px) {
    .legend-panel {
        width: 220px;
        max-height: 60vh;
    }
}

</style>
</head>
<body>
    <div class="app-container">
        <!-- Botões laterais de navegação -->
        <a href="contexto-historico.html" class="nav-lateral prev">‹</a>
        <a href="diagnostico-impactos.html" class="nav-lateral next">›</a>
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="header-title">COVID-19 - Grafo Epidemiológico Brasil</h1>
            </div>
            <div class="header-stats">
                <span id="node-count">0 Estados</span>
                <span id="edge-count">0 Conexões</span>
                <span id="cluster-count">0 Clusters</span>
            </div>
        </header>
        

        <!-- Executive Report Modal -->
        <aside class="executive-report">
            <div class="report-modal">
                <div class="report-header">
                    <div class="report-title">COVID-19: Impactos Estratégicos para Negócios</div>
                    <div class="report-subtitle">Executive Summary</div>
                    <div class="report-context">Análise epidemiológica aplicada à tomada de decisão corporativa</div>
                </div>

                <div class="report-content">
                    <p>As restrições de mobilidade durante Mar/2020-Fev/2021 seguiram padrões epidemiológicos específicos que impactaram diferencialmente as regiões econômicas, criando oportunidades estratégicas para preparação futura.</p>
                    
                    <div class="key-insight">
                        <div class="insight-highlight">Impacto das Restrições por Cluster</div>
                        <p>Cluster SP-RJ enfrentou restrições simultâneas desde Abr/2020. Amazonas teve isolamento geográfico natural (Jun/2020), enquanto Sul manteve-se operacional até Set/2020, oferecendo janela de 6 meses de continuidade.</p>
                    </div>

                    <p><strong>Padrão Temporal:</strong> Restrições seguem correlação ≥80% entre estados conectados. Bahia como hub regional (Jul/2020) demonstra efeito cascata - quando epicentro regional é restrito, estados conectados seguem em 30-45 dias.</p>

                    <p><strong>Pico de Restrições (Out/2020):</strong> Intensidade 100% com todos os 5 clusters sob restrições simultâneas. Nenhuma região manteve mobilidade plena, evidenciando vulnerabilidade nacional.</p>

                    <div class="business-conclusion">
                        <strong>Recomendações Estratégicas:</strong> Estabelecer operações em estados com baixa correlação epidemiológica (&lt;60%). Manter centros alternativos em regiões geograficamente isoladas (modelo Amazonas). Implementar protocolos escalonados baseados na sequência observada: SP→RJ→CE→BA→PR.
                    </div>
                </div>
            </div>
        </aside>

        <!-- Legenda Lateral -->
        <aside class="legend-panel" id="legend-panel">
            <div class="legend-toggle-handle" id="legend-toggle">Legenda</div>
            <div class="legend-section">
                <div class="legend-title">🧬 Clusters ML</div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #FF6B6B; border-radius: 3px;"></div>
                    <div class="legend-description">
                        <strong>Cluster 1 - Norte Isolado</strong><br>
                        Amazonas (epicentro isolado)
                    </div>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #4ECDC4; border-radius: 3px;"></div>
                    <div class="legend-description">
                        <strong>Cluster 2 - São Paulo</strong><br>
                        Centro econômico nacional
                    </div>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #45B7D1; border-radius: 3px;"></div>
                    <div class="legend-description">
                        <strong>Cluster 3 - Nordeste-Sudeste</strong><br>
                        Corredor epidemiológico principal
                    </div>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #96CEB4; border-radius: 3px;"></div>
                    <div class="legend-description">
                        <strong>Cluster 4 - Norte-Nordeste</strong><br>
                        Maranhão-Pará (conexão norte)
                    </div>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #FFEAA7; border-radius: 3px;"></div>
                    <div class="legend-description">
                        <strong>Cluster 5 - Sul-Centro</strong><br>
                        Múltiplos epicentros regionais
                    </div>
                </div>
            </div>

            <div class="legend-section">
                <div class="legend-title">📊 Intensidade de Correlação</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00D4FF;"></div>
                    <div class="legend-description">
                        <strong>Correlação Forte</strong> (≥80%)<br>
                        Alto risco de propagação simultânea
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFD700;"></div>
                    <div class="legend-description">
                        <strong>Correlação Moderada</strong> (60-79%)<br>
                        Risco moderado de propagação
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF6B6B;"></div>
                    <div class="legend-description">
                        <strong>Correlação Fraca</strong> (<60%)<br>
                        Baixo risco de propagação
                    </div>
                </div>
            </div>

            <div class="legend-section">
                <div class="legend-title">⚡ Animações</div>
                <div class="legend-item">
                    <div class="legend-pulse" style="background: #FFBC82;"></div>
                    <div class="legend-description">
                        <strong>Pulsos Epidemiológicos</strong><br>
                        Epicentros de surtos
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-particle" style="background: #00D4FF;"></div>
                    <div class="legend-description">
                        <strong>Partículas Viajantes</strong><br>
                        Propagação entre estados
                    </div>
                </div>
            </div>

            <div class="legend-section">
                <div class="legend-title">🎯 Interações</div>
                <div class="legend-item">
                    <div style="width: 18px; height: 18px; border: 2px solid var(--azul-marinho); border-radius: 50%; cursor: pointer;"></div>
                    <div class="legend-description">
                        <strong>Click nos Estados</strong><br>
                        Ativa simulação epidemiológica
                    </div>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 3px; background: var(--salmao); cursor: pointer;"></div>
                    <div class="legend-description">
                        <strong>Click nas Conexões</strong><br>
                        Animação de propagação
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Visualization -->
        <main class="main-viz">
            <div id="map-container">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>Carregando dados do Brasil...</div>
                </div>
            </div>
        </main>

        <!-- Timeline Controls - Versão Compacta -->
        <div class="timeline-controls" id="timeline-controls">
            <div class="timeline-toggle-handle" id="timeline-toggle">Timeline</div>
            <div class="timeline-date" id="current-timeline-date">Mar 2020</div>
            
            <div class="timeline-slider-container">
                <input type="range" id="timeline-slider" class="timeline-slider" 
                       min="0" max="11" value="0" step="1">
                <div class="timeline-marks">
                    <span class="timeline-mark">Mar</span>
                    <span class="timeline-mark">Abr</span>
                    <span class="timeline-mark">Mai</span>
                    <span class="timeline-mark">Jun</span>
                    <span class="timeline-mark">Jul</span>
                    <span class="timeline-mark">Ago</span>
                    <span class="timeline-mark">Set</span>
                    <span class="timeline-mark">Out</span>
                    <span class="timeline-mark">Nov</span>
                    <span class="timeline-mark">Dez</span>
                    <span class="timeline-mark">Jan</span>
                    <span class="timeline-mark">Fev</span>
                </div>
            </div>
            
            <div class="control-buttons">
                <button class="control-btn" id="play-btn">
                    ▶ Play
                </button>
                <button class="control-btn" id="reset-btn">
                    ↻ Reset
                </button>
                <select class="speed-selector" id="speed-selector">
                    <option value="2000">0.5x</option>
                    <option value="1000" selected>1x</option>
                    <option value="500">2x</option>
                    <option value="250">4x</option>
                </select>
            </div>
            
        </div>

        <!-- Period Info Panel -->
        <div class="period-info" id="period-info">
            <div class="period-title">
                <span class="period-icon" id="period-icon">📍</span>
                <span id="period-title-text">O Início</span>
                <span class="period-intensity" id="period-intensity-badge">10%</span>
            </div>
            <ul class="period-bullets" id="period-bullets">
                <!-- Bullets serão inseridos dinamicamente -->
            </ul>
        </div>

        <!-- Footer removido para maximizar área do mapa -->
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip" style="display: none;"></div>

    <script>
        // === CONFIGURAÇÕES GLOBAIS ===
        const CONFIG = {
            width: Math.max(800, window.innerWidth - 150), // Largura mínima + área da esquerda
            height: Math.max(600, window.innerHeight - 60), // Altura mínima + header
            clusters: {
                1: { color: '#FF6B6B', name: 'Cluster Norte Isolado' },
                2: { color: '#4ECDC4', name: 'Cluster São Paulo' },
                3: { color: '#45B7D1', name: 'Cluster Nordeste-Sudeste' },
                4: { color: '#96CEB4', name: 'Cluster Norte-Nordeste' },
                5: { color: '#FFEAA7', name: 'Cluster Sul-Centro' }
            }
        };

        // === VARIÁVEIS GLOBAIS ===
        let svg, g, projection, path;
        let brazilData, nodesData, edgesData;
        let selectedState = null;

        // Configurações da animação da timeline
        const TEMPORAL_DATA = {
            months: [
                { 
                    name: 'Mar 2020', date: '2020-03', intensity: 0.1, 
                    epicenters: ['São Paulo'],
                    title: 'O Início',
                    icon: '📍',
                    bullets: [
                        'Primeiro caso confirmado no Brasil',
                        'Foco na região metropolitana de SP',
                        'Conexões limitadas entre estados',
                        'SP como único nó destacado'
                    ]
                },
                { 
                    name: 'Abr 2020', date: '2020-04', intensity: 0.2, 
                    epicenters: ['São Paulo', 'Rio de Janeiro'],
                    title: 'Expansão Metropolitana',
                    icon: '🏢',
                    bullets: [
                        'Expansão para o eixo SP-RJ',
                        'Primeiras conexões fortes entre megacidades',
                        'Início dos Clusters 2 (SP) e 5 (RJ)',
                        'Partículas viajantes entre epicentros'
                    ]
                },
                { 
                    name: 'Mai 2020', date: '2020-05', intensity: 0.4, 
                    epicenters: ['São Paulo', 'Rio de Janeiro', 'Ceará'],
                    title: 'Corredor Nordeste',
                    icon: '✈️',
                    bullets: [
                        'Entrada do vírus no Nordeste via Ceará',
                        'Formação do Cluster 3 (Nordeste-Sudeste)',
                        'Conexões aéreas facilitando propagação',
                        'Triangulação SP-RJ-CE visível'
                    ]
                },
                { 
                    name: 'Jun 2020', date: '2020-06', intensity: 0.5, 
                    epicenters: ['São Paulo', 'Rio de Janeiro', 'Ceará', 'Amazonas'],
                    title: 'Amazônia Isolada',
                    icon: '🌲',
                    bullets: [
                        'Colapso do sistema de saúde no Amazonas',
                        'Formação do Cluster 1 (Norte Isolado)',
                        'Propagação via hidrovias e transporte aéreo',
                        'Amazonas como epicentro isolado geograficamente'
                    ]
                },
                { 
                    name: 'Jul 2020', date: '2020-07', intensity: 0.7, 
                    epicenters: ['São Paulo', 'Rio de Janeiro', 'Ceará', 'Amazonas', 'Bahia'],
                    title: 'Interiorização',
                    icon: '🏡',
                    bullets: [
                        'Interiorização da pandemia',
                        'Bahia como hub do Nordeste',
                        'Consolidação do Cluster 3',
                        'Corredor epidemiológico bem definido'
                    ]
                },
                { 
                    name: 'Ago 2020', date: '2020-08', intensity: 0.8, 
                    epicenters: ['São Paulo', 'Rio de Janeiro', 'Ceará', 'Amazonas', 'Bahia', 'Minas Gerais'],
                    title: 'Consolidação Regional',
                    icon: '🤝',
                    bullets: [
                        'MG como conector entre regiões',
                        'Consolidação dos clusters regionais',
                        'Pico de conexões inter-regionais',
                        'Formação clara dos 5 clusters'
                    ]
                },
                { 
                    name: 'Set 2020', date: '2020-09', intensity: 0.9, 
                    epicenters: ['São Paulo', 'Rio de Janeiro', 'Ceará', 'Amazonas', 'Bahia', 'Minas Gerais', 'Paraná'],
                    title: 'Expansão Sul',
                    icon: '📊',
                    bullets: [
                        'Entrada da Região Sul',
                        'PR como porta de entrada do Sul',
                        'Conexões Sul-Sudeste se intensificando',
                        'Início do Cluster 5 (Sul-Centro)'
                    ]
                },
                { 
                    name: 'Out 2020', date: '2020-10', intensity: 1.0, 
                    epicenters: ['São Paulo', 'Rio de Janeiro', 'Ceará', 'Amazonas', 'Bahia', 'Minas Gerais', 'Paraná', 'Rio Grande do Sul'],
                    title: 'Pico Nacional',
                    icon: '🔴',
                    bullets: [
                        'Pico da pandemia no Brasil',
                        'Todos os clusters ativos simultaneamente',
                        'Máxima conectividade entre estados',
                        'Máxima atividade de partículas e pulsos'
                    ]
                },
                { 
                    name: 'Nov 2020', date: '2020-11', intensity: 0.95, 
                    epicenters: ['São Paulo', 'Rio de Janeiro', 'Ceará', 'Amazonas', 'Bahia', 'Minas Gerais', 'Paraná', 'Rio Grande do Sul', 'Santa Catarina'],
                    title: 'Estabilização',
                    icon: '⚖️',
                    bullets: [
                        'Estabilização em níveis altos',
                        'SC completando a região Sul',
                        'Manutenção de conexões fortes',
                        'Clusters consolidados'
                    ]
                },
                { 
                    name: 'Dez 2020', date: '2020-12', intensity: 0.85, 
                    epicenters: ['São Paulo', 'Rio de Janeiro', 'Ceará', 'Amazonas', 'Bahia', 'Minas Gerais', 'Paraná', 'Rio Grande do Sul', 'Santa Catarina', 'Goiás'],
                    title: 'Expansão Centro-Oeste',
                    icon: '🏠',
                    bullets: [
                        'Centro-Oeste entrando no cenário',
                        'GO como hub regional',
                        'Conexões com DF se intensificando',
                        'Expansão para o interior'
                    ]
                },
                { 
                    name: 'Jan 2021', date: '2021-01', intensity: 0.9, 
                    epicenters: ['São Paulo', 'Rio de Janeiro', 'Ceará', 'Amazonas', 'Bahia', 'Minas Gerais', 'Paraná', 'Rio Grande do Sul', 'Santa Catarina', 'Goiás', 'Pernambuco'],
                    title: 'Segunda Onda',
                    icon: '📈',
                    bullets: [
                        'Segunda onda nacional',
                        'PE como novo epicentro nordestino',
                        'Intensificação das conexões existentes',
                        'Aumento da intensidade geral'
                    ]
                },
                { 
                    name: 'Fev 2021', date: '2021-02', intensity: 0.8, 
                    epicenters: ['São Paulo', 'Rio de Janeiro', 'Ceará', 'Amazonas', 'Bahia', 'Minas Gerais', 'Paraná', 'Rio Grande do Sul', 'Santa Catarina', 'Goiás', 'Pernambuco', 'Maranhão'],
                    title: 'Estabilização Regional',
                    icon: '💉',
                    bullets: [
                        'MA completando o Cluster 4',
                        'Estabilização em níveis controlados',
                        'Preparação para vacinação',
                        'Manutenção dos clusters formados'
                    ]
                }
            ]
        };

        let animationSettings = {
            isPlaying: false,
            currentStep: 0,
            totalSteps: TEMPORAL_DATA.months.length,
            speed: 1500, // ms por passo
            playbackInterval: null
        };

        let currentFilters = {
            weight: 0,
            region: 'all',
            clusters: new Set([1, 2, 3, 4, 5])
        };
        let showConnections = true, showNodes = true, showLabels = false;

        // === DADOS EMBUTIDOS ===
        const EMBEDDED_NODES = [
            {
                "node_id": 1,
                "estado": "Minas Gerais",
                "regiao": "Sudeste",
                "latitude": -18.5122,
                "longitude": -44.555,
                "casos_total": 3621242,
                "obitos_total": 62149,
                "casos_per_100k": 18478.24,
                "populacao": 19597330,
                "workplace_avg": 7.90,
                "stringency_avg": 57.16,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Alto",
                "cluster_id": 3,
                "distancia_centroide": 1.63
            },
            {
                "node_id": 2,
                "estado": "Maranhão",
                "regiao": "Nordeste",
                "latitude": -4.9609,
                "longitude": -45.2744,
                "casos_total": 443241,
                "obitos_total": 10896,
                "casos_per_100k": 6741.52,
                "populacao": 6574789,
                "workplace_avg": 12.23,
                "stringency_avg": 52.70,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Baixo",
                "cluster_id": 4,
                "distancia_centroide": 0.81
            },
            {
                "node_id": 3,
                "estado": "Rio Grande do Sul",
                "regiao": "Sul",
                "latitude": -29.7508,
                "longitude": -53.7776,
                "casos_total": 2547247,
                "obitos_total": 40027,
                "casos_per_100k": 23819.56,
                "populacao": 10693929,
                "workplace_avg": 5.97,
                "stringency_avg": 56.98,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Alto",
                "cluster_id": 5,
                "distancia_centroide": 1.30
            },
            {
                "node_id": 4,
                "estado": "Rio de Janeiro",
                "regiao": "Sudeste",
                "latitude": -22.9129,
                "longitude": -43.2003,
                "casos_total": 2348485,
                "obitos_total": 74134,
                "casos_per_100k": 14687.28,
                "populacao": 15989929,
                "workplace_avg": 4.34,
                "stringency_avg": 54.02,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Medio",
                "cluster_id": 5,
                "distancia_centroide": 2.11
            },
            {
                "node_id": 5,
                "estado": "São Paulo",
                "regiao": "Sudeste",
                "latitude": -23.5587,
                "longitude": -46.625,
                "casos_total": 5718492,
                "obitos_total": 170907,
                "casos_per_100k": 13858.91,
                "populacao": 41262199,
                "workplace_avg": 5.62,
                "stringency_avg": 48.13,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Medio",
                "cluster_id": 2,
                "distancia_centroide": 0.00
            },
            {
                "node_id": 6,
                "estado": "Paraná",
                "regiao": "Sul",
                "latitude": -24.89,
                "longitude": -51.55,
                "casos_total": 2623126,
                "obitos_total": 43774,
                "casos_per_100k": 25114.84,
                "populacao": 10444526,
                "workplace_avg": 9.57,
                "stringency_avg": 58.31,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Alto",
                "cluster_id": 5,
                "distancia_centroide": 2.15
            },
            {
                "node_id": 7,
                "estado": "Distrito Federal",
                "regiao": "Centro-Oeste",
                "latitude": -15.826,
                "longitude": -47.9292,
                "casos_total": 805736,
                "obitos_total": 11759,
                "casos_per_100k": 31349.64,
                "populacao": 2570160,
                "workplace_avg": -3.22,
                "stringency_avg": null,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Alto",
                "cluster_id": 5,
                "distancia_centroide": 2.20
            },
            {
                "node_id": 8,
                "estado": "Ceará",
                "regiao": "Nordeste",
                "latitude": -5.20404,
                "longitude": -39.2914,
                "casos_total": 1266399,
                "obitos_total": 27186,
                "casos_per_100k": 14982.75,
                "populacao": 8452381,
                "workplace_avg": 2.61,
                "stringency_avg": 64.61,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Medio",
                "cluster_id": 3,
                "distancia_centroide": 1.75
            },
            {
                "node_id": 9,
                "estado": "Amazonas",
                "regiao": "Norte",
                "latitude": -3.119,
                "longitude": -60.0212,
                "casos_total": 585103,
                "obitos_total": 14178,
                "casos_per_100k": 16794.07,
                "populacao": 3483985,
                "workplace_avg": 22.57,
                "stringency_avg": 65.16,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Alto",
                "cluster_id": 1,
                "distancia_centroide": 0.00
            },
            {
                "node_id": 10,
                "estado": "Pará",
                "regiao": "Norte",
                "latitude": -5.53,
                "longitude": -52.296,
                "casos_total": 782892,
                "obitos_total": 18463,
                "casos_per_100k": 10326.96,
                "populacao": 7581051,
                "workplace_avg": 13.45,
                "stringency_avg": 55.47,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Medio",
                "cluster_id": 4,
                "distancia_centroide": 0.81
            },
            {
                "node_id": 11,
                "estado": "Santa Catarina",
                "regiao": "Sul",
                "latitude": -27.45,
                "longitude": -50.95,
                "casos_total": 1794189,
                "obitos_total": 22029,
                "casos_per_100k": 28714.21,
                "populacao": 6248436,
                "workplace_avg": 8.16,
                "stringency_avg": 59.89,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Alto",
                "cluster_id": 5,
                "distancia_centroide": 2.26
            },
            {
                "node_id": 12,
                "estado": "Bahia",
                "regiao": "Nordeste",
                "latitude": -12.5797,
                "longitude": -41.7007,
                "casos_total": 1576509,
                "obitos_total": 30031,
                "casos_per_100k": 11247.20,
                "populacao": 14016906,
                "workplace_avg": 5.33,
                "stringency_avg": 57.61,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Medio",
                "cluster_id": 3,
                "distancia_centroide": 1.05
            },
            {
                "node_id": 13,
                "estado": "Pernambuco",
                "regiao": "Nordeste",
                "latitude": -8.8137,
                "longitude": -36.9541,
                "casos_total": 976385,
                "obitos_total": 21867,
                "casos_per_100k": 11099.76,
                "populacao": 8796448,
                "workplace_avg": 4.90,
                "stringency_avg": 56.80,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Medio",
                "cluster_id": 3,
                "distancia_centroide": 1.12
            },
            {
                "node_id": 14,
                "estado": "Goiás",
                "regiao": "Centro-Oeste",
                "latitude": -15.827,
                "longitude": -49.8362,
                "casos_total": 1501978,
                "obitos_total": 26882,
                "casos_per_100k": 25017.17,
                "populacao": 6003788,
                "workplace_avg": 9.82,
                "stringency_avg": 53.76,
                "categoria_entrada": "Entrada_Precoce",
                "categoria_impacto": "Impacto_Alto",
                "cluster_id": 5,
                "distancia_centroide": 2.00
            }
        ];

        const EMBEDDED_EDGES = [
            {
                "source": "São Paulo",
                "target": "Rio de Janeiro", 
                "weight": 0.85,
                "corr_casos_simultaneos": 0.78,
                "cluster_match": false,
                "distance_km": 358
            },
            {
                "source": "São Paulo",
                "target": "Minas Gerais",
                "weight": 0.72,
                "corr_casos_simultaneos": 0.65,
                "cluster_match": false,
                "distance_km": 446
            },
            {
                "source": "Rio de Janeiro",
                "target": "Minas Gerais",
                "weight": 0.68,
                "corr_casos_simultaneos": 0.71,
                "cluster_match": false,
                "distance_km": 356
            },
            {
                "source": "Rio Grande do Sul",
                "target": "Santa Catarina",
                "weight": 0.91,
                "corr_casos_simultaneos": 0.87,
                "cluster_match": true,
                "distance_km": 254
            },
            {
                "source": "Rio Grande do Sul",
                "target": "Paraná",
                "weight": 0.83,
                "corr_casos_simultaneos": 0.79,
                "cluster_match": true,
                "distance_km": 285
            },
            {
                "source": "Santa Catarina",
                "target": "Paraná",
                "weight": 0.88,
                "corr_casos_simultaneos": 0.84,
                "cluster_match": true,
                "distance_km": 156
            },
            {
                "source": "Paraná",
                "target": "São Paulo",
                "weight": 0.76,
                "corr_casos_simultaneos": 0.69,
                "cluster_match": false,
                "distance_km": 408
            },
            {
                "source": "Minas Gerais",
                "target": "Ceará",
                "weight": 0.74,
                "corr_casos_simultaneos": 0.68,
                "cluster_match": true,
                "distance_km": 1189
            },
            {
                "source": "Minas Gerais",
                "target": "Bahia",
                "weight": 0.79,
                "corr_casos_simultaneos": 0.73,
                "cluster_match": true,
                "distance_km": 754
            },
            {
                "source": "Minas Gerais",
                "target": "Pernambuco",
                "weight": 0.71,
                "corr_casos_simultaneos": 0.66,
                "cluster_match": true,
                "distance_km": 1065
            },
            {
                "source": "Ceará",
                "target": "Pernambuco",
                "weight": 0.82,
                "corr_casos_simultaneos": 0.77,
                "cluster_match": true,
                "distance_km": 624
            },
            {
                "source": "Ceará",
                "target": "Bahia",
                "weight": 0.75,
                "corr_casos_simultaneos": 0.70,
                "cluster_match": true,
                "distance_km": 906
            },
            {
                "source": "Bahia",
                "target": "Pernambuco",
                "weight": 0.77,
                "corr_casos_simultaneos": 0.72,
                "cluster_match": true,
                "distance_km": 592
            },
            {
                "source": "Maranhão",
                "target": "Pará",
                "weight": 0.89,
                "corr_casos_simultaneos": 0.86,
                "cluster_match": true,
                "distance_km": 512
            },
            {
                "source": "Maranhão",
                "target": "Ceará",
                "weight": 0.65,
                "corr_casos_simultaneos": 0.58,
                "cluster_match": false,
                "distance_km": 634
            },
            {
                "source": "Pará",
                "target": "Amazonas",
                "weight": 0.58,
                "corr_casos_simultaneos": 0.52,
                "cluster_match": false,
                "distance_km": 1378
            },
            {
                "source": "Rio de Janeiro",
                "target": "Rio Grande do Sul",
                "weight": 0.69,
                "corr_casos_simultaneos": 0.63,
                "cluster_match": true,
                "distance_km": 1110
            },
            {
                "source": "Rio de Janeiro",
                "target": "Paraná",
                "weight": 0.73,
                "corr_casos_simultaneos": 0.67,
                "cluster_match": true,
                "distance_km": 676
            },
            {
                "source": "Rio de Janeiro",
                "target": "Santa Catarina",
                "weight": 0.71,
                "corr_casos_simultaneos": 0.65,
                "cluster_match": true,
                "distance_km": 834
            },
            {
                "source": "Distrito Federal",
                "target": "Goiás",
                "weight": 0.93,
                "corr_casos_simultaneos": 0.91,
                "cluster_match": true,
                "distance_km": 147
            }
        ];

        // GeoJSON melhorado do Brasil para fallback - formato mais realista
        const BRAZIL_GEOJSON = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {"NAME": "Amazonas", "name": "Amazonas", "id": "AM", "CODIBGE": "13"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-73.79,-2.25],[-69.87,-4.29],[-66.88,-0.04],[-62.79,-2.24],[-60.23,-3.05],[-59.04,-4.72],[-57.62,-4.95],[-56.47,-2.61],[-54.18,-2.32],[-53.04,-3.95],[-51.31,-4.15],[-49.87,-1.66],[-49.49,-0.29],[-50.39,0.63],[-52.25,1.23],[-54.18,2.26],[-56.47,1.85],[-58.79,1.38],[-60.93,2.83],[-62.79,4.11],[-66.30,3.57],[-68.15,2.49],[-70.04,0.18],[-72.26,-0.44],[-73.79,-2.25]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Pará", "name": "Pará", "id": "PA", "CODIBGE": "15"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-59.04,-4.72],[-60.23,-3.05],[-62.79,-2.24],[-66.88,-0.04],[-67.84,-2.82],[-68.78,-3.70],[-68.15,-5.49],[-66.88,-8.04],[-64.54,-9.08],[-62.79,-10.85],[-60.93,-12.37],[-58.79,-10.12],[-56.47,-8.72],[-54.18,-6.95],[-51.87,-5.28],[-49.87,-3.41],[-49.04,-1.89],[-49.87,-1.66],[-51.31,-4.15],[-53.04,-3.95],[-54.18,-2.32],[-56.47,-2.61],[-57.62,-4.95],[-59.04,-4.72]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Maranhão", "name": "Maranhão", "id": "MA", "CODIBGE": "21"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-49.04,-1.89],[-47.04,-2.84],[-45.27,-2.32],[-43.36,-2.59],[-41.77,-2.84],[-40.18,-3.95],[-39.04,-5.49],[-38.47,-7.26],[-39.85,-8.30],[-41.77,-9.08],[-43.95,-8.95],[-45.88,-8.04],[-47.81,-7.26],[-49.74,-6.21],[-51.31,-5.28],[-51.87,-5.28],[-49.87,-3.41],[-49.04,-1.89]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Ceará", "name": "Ceará", "id": "CE", "CODIBGE": "23"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-40.18,-3.95],[-41.77,-2.84],[-43.36,-2.59],[-45.27,-2.32],[-46.40,-3.70],[-47.04,-4.99],[-46.67,-6.47],[-45.27,-7.26],[-43.95,-8.04],[-42.26,-8.30],[-40.51,-7.78],[-38.76,-6.73],[-37.40,-5.69],[-37.01,-4.38],[-37.64,-3.33],[-39.04,-3.05],[-40.18,-3.95]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Pernambuco", "name": "Pernambuco", "id": "PE", "CODIBGE": "26"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-40.51,-7.78],[-42.26,-8.30],[-43.95,-8.04],[-45.88,-8.04],[-46.67,-9.34],[-45.88,-10.38],[-44.16,-11.16],[-42.26,-10.64],[-40.51,-9.86],[-38.76,-8.82],[-37.40,-7.78],[-36.65,-8.56],[-35.77,-9.34],[-34.89,-8.82],[-35.27,-7.78],[-36.40,-7.26],[-37.64,-6.73],[-38.76,-6.73],[-40.51,-7.78]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Bahia", "name": "Bahia", "id": "BA", "CODIBGE": "29"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-47.81,-7.26],[-49.74,-6.21],[-51.31,-5.28],[-51.87,-8.04],[-52.63,-10.12],[-52.25,-12.37],[-50.39,-14.36],[-48.45,-16.09],[-46.52,-17.39],[-44.58,-18.17],[-42.64,-17.65],[-40.70,-16.87],[-38.76,-15.83],[-37.40,-14.10],[-36.65,-12.37],[-37.01,-10.64],[-38.76,-8.82],[-40.51,-9.86],[-42.26,-10.64],[-44.16,-11.16],[-45.88,-10.38],[-46.67,-9.34],[-45.88,-8.04],[-47.81,-7.26]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Minas Gerais", "name": "Minas Gerais", "id": "MG", "CODIBGE": "31"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-50.39,-14.36],[-52.25,-12.37],[-52.63,-10.12],[-51.87,-8.04],[-49.74,-15.83],[-47.81,-17.13],[-45.88,-18.43],[-43.95,-19.47],[-42.01,-20.25],[-40.07,-21.03],[-38.14,-19.99],[-36.20,-18.69],[-34.89,-17.39],[-35.27,-15.83],[-36.65,-14.10],[-37.40,-14.10],[-38.76,-15.83],[-40.70,-16.87],[-42.64,-17.65],[-44.58,-18.17],[-46.52,-17.39],[-48.45,-16.09],[-50.39,-14.36]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "São Paulo", "name": "São Paulo", "id": "SP", "CODIBGE": "35"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-49.74,-20.25],[-51.68,-19.47],[-53.61,-20.77],[-54.37,-22.50],[-53.23,-24.23],[-51.68,-25.01],[-49.74,-25.79],[-47.81,-25.27],[-45.88,-24.49],[-44.32,-23.19],[-43.56,-21.72],[-44.32,-20.25],[-45.88,-19.47],[-47.81,-18.95],[-49.74,-20.25]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Rio de Janeiro", "name": "Rio de Janeiro", "id": "RJ", "CODIBGE": "33"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-43.56,-21.72],[-44.32,-23.19],[-45.88,-24.49],[-47.04,-23.71],[-47.42,-22.41],[-46.67,-21.03],[-45.12,-20.51],[-43.56,-21.72]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Paraná", "name": "Paraná", "id": "PR", "CODIBGE": "41"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-54.37,-22.50],[-56.31,-23.80],[-57.45,-25.53],[-56.69,-27.26],[-54.76,-28.04],[-52.82,-27.52],[-50.89,-26.74],[-49.74,-25.79],[-51.68,-25.01],[-53.23,-24.23],[-54.37,-22.50]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Santa Catarina", "name": "Santa Catarina", "id": "SC", "CODIBGE": "42"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-56.69,-27.26],[-57.45,-25.53],[-58.58,-26.83],[-58.96,-28.56],[-57.82,-29.60],[-55.89,-29.34],[-53.95,-28.82],[-52.01,-28.56],[-50.89,-27.78],[-52.82,-27.52],[-54.76,-28.04],[-56.69,-27.26]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Rio Grande do Sul", "name": "Rio Grande do Sul", "id": "RS", "CODIBGE": "43"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-57.82,-29.60],[-58.96,-28.56],[-59.72,-30.29],[-58.58,-32.02],[-56.65,-33.32],[-54.71,-33.84],[-52.78,-33.58],[-50.84,-33.06],[-49.70,-32.28],[-50.89,-31.50],[-52.82,-30.98],[-54.76,-30.72],[-55.89,-29.34],[-57.82,-29.60]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Goiás", "name": "Goiás", "id": "GO", "CODIBGE": "52"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-52.25,-12.37],[-54.18,-11.33],[-55.70,-12.89],[-55.32,-14.88],[-54.18,-16.87],[-52.63,-18.43],[-50.70,-18.95],[-48.76,-18.43],[-47.42,-16.87],[-48.07,-15.05],[-49.74,-13.32],[-51.31,-12.37],[-52.25,-12.37]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {"NAME": "Distrito Federal", "name": "Distrito Federal", "id": "DF", "CODIBGE": "53"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[-47.79,-15.50],[-47.42,-15.76],[-47.25,-15.94],[-47.35,-16.04],[-47.56,-15.89],[-47.79,-15.63],[-47.79,-15.50]]]
                    }
                }
            ]
        };

        // === INICIALIZAÇÃO ===
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('[DEBUG] Iniciando initVisualization...');
                await initVisualization();
                console.log('[DEBUG] initVisualization concluída');
            } catch (error) {
                console.error('[ERROR] Erro na inicialização:', error, error && error.stack);
                alert('Erro na inicialização: ' + (error && error.stack ? error.stack : error));
            }
        });

        async function initVisualization() {
            try {
                console.log('[DEBUG] Iniciando carregamento de dados...');
                // Carregar dados
                await loadData();
                
                // Configurar SVG
                setupSVG();
                
                // Desenhar mapa e grafo uma única vez
                drawBrazilMap();
                drawGraph();
                
                // Configurar o comportamento de zoom
                const zoom = d3.zoom()
                    .scaleExtent([0.8, 12]) // Limites de zoom
                    .on('zoom', (event) => {
                        g.attr('transform', event.transform);
                    });
                
                svg.call(zoom);

                // Configurar controles da timeline
                setupTimelineControls();
                
                // Setup do toggle da legenda
                setupLegendToggle();
                
                // Inicializar painel de informações
                initializePeriodInfo();
                
                // Forçar atualização inicial das dimensões
                window.dispatchEvent(new Event('resize'));

                console.log('Visualização carregada com layout otimizado');
                
            } catch (error) {
                console.error('Erro na inicialização:', error);
            } finally {
                // Esconder loading independentemente do resultado
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            }
        }

        // === CARREGAMENTO DE DADOS ===
        async function loadData() {
            try {
                // Lista de URLs de TopoJSON para tentar - começando com arquivo local
                const topojsonUrls = [
                    './br-states.json', // Arquivo local primeiro
                    'https://gist.githubusercontent.com/ruliana/1ccaaab05ea113b0dff3b22be3b4d637/raw/br-states.json',
                    'https://raw.githubusercontent.com/hekima/d3-map/master/data/br-states.json',
                    'https://servicodados.ibge.gov.br/api/v3/malhas/estados/BR?formato=application/json'
                ];
                
                let brazilLoaded = false;
                
                // Tentar carregar de cada URL
                for (const url of topojsonUrls) {
                    try {
                        console.log(`Tentando carregar dados de: ${url}`);
                        const brazilTopoJSON = await d3.json(url);
                        brazilData = brazilTopoJSON;
                        brazilLoaded = true;
                        console.log(`TopoJSON carregado com sucesso de: ${url}`);
                        break;
                    } catch (urlError) {
                        console.warn(`Falha ao carregar de ${url}:`, urlError);
                        continue;
                    }
                }
                
                // Se nenhuma URL funcionou, usar fallback
                if (!brazilLoaded) {
                    console.warn('Todas as URLs falharam, usando GeoJSON fallback');
                    brazilData = BRAZIL_GEOJSON;
                }

                // Dados dos nós e arestas (sempre embutidos)
                nodesData = EMBEDDED_NODES;
                edgesData = EMBEDDED_EDGES;

                console.log('Dados carregados:', { 
                    states: nodesData.length, 
                    connections: edgesData.length,
                    mapSource: brazilLoaded ? 'TopoJSON externo' : 'GeoJSON fallback'
                });

                updateStats();
            } catch (error) {
                console.error('Erro no carregamento:', error);
                throw error;
            }
        }

        function updateStats() {
            document.getElementById('node-count').textContent = `${nodesData.length} Estados`;
            document.getElementById('edge-count').textContent = `${edgesData.length} Conexões`;
            document.getElementById('cluster-count').textContent = `5 Clusters`;
        }

        // === CONFIGURAÇÃO DO SVG ===
        function setupSVG() {
            // Remover SVG existente
            d3.select('#map-container svg').remove();

            // Criar novo SVG
            svg = d3.select('#map-container')
                .append('svg')
                .attr('width', window.innerWidth)
                .attr('height', window.innerHeight - 60)
                .style('position', 'absolute')
                .style('top', 0)
                .style('right', 0)
                .style('left', 0)
                .style('bottom', 0);

            // Grupo principal
            g = svg.append('g');

            // Configurar projeção do mapa (otimizada para o Brasil)
            projection = d3.geoMercator()
                .center([-52, -15])
                .scale(Math.min(window.innerWidth, window.innerHeight - 60) * 1.33) // Escala máxima para preencher quase tudo
                .translate([window.innerWidth * 0.59, (window.innerHeight - 60) / 2]); // Joga o mapa mais para a direita

            path = d3.geoPath().projection(projection);
        }

        // === DESENHO DO MAPA DO BRASIL ===
        function drawBrazilMap() {
            if (!brazilData) {
                console.error('Dados do Brasil não encontrados');
                drawFallbackMap();
                return;
            }

            // Limpar mapa existente para evitar duplicação
            g.selectAll('.map-group').remove();

            try {
                let features;
                
                // Debug: Examinar estrutura dos dados
                console.log('Estrutura dos dados do Brasil:', {
                    type: brazilData.type,
                    hasObjects: !!brazilData.objects,
                    hasFeatures: !!brazilData.features,
                    objects: brazilData.objects ? Object.keys(brazilData.objects) : null,
                    firstLevelKeys: Object.keys(brazilData)
                });
                
                // Verificar se é TopoJSON ou GeoJSON
                if (brazilData.objects) {
                    // É TopoJSON - tentar várias chaves possíveis
                    const possibleKeys = Object.keys(brazilData.objects);
                    console.log('Chaves disponíveis no objects:', possibleKeys);
                    
                    let objectKey = null;
                    if (brazilData.objects.states) {
                        objectKey = 'states';
                    } else if (brazilData.objects.br_states) {
                        objectKey = 'br_states';
                    } else if (brazilData.objects.estados) {
                        objectKey = 'estados';
                    } else if (possibleKeys.length > 0) {
                        objectKey = possibleKeys[0]; // Usar a primeira chave disponível
                    }
                    
                    if (objectKey) {
                        features = topojson.feature(brazilData, brazilData.objects[objectKey]).features;
                        console.log(`Usando TopoJSON oficial do Brasil (chave: ${objectKey})`);
                    } else {
                        throw new Error('Nenhuma chave válida encontrada no objects');
                    }
                } else if (brazilData.features) {
                    // É GeoJSON fallback
                    features = brazilData.features;
                    console.log('Usando GeoJSON fallback');
                } else {
                    console.error('Estrutura de dados:', brazilData);
                    throw new Error('Formato de dados não reconhecido');
                }

                console.log(`Features encontradas: ${features.length}`);
                if (features.length > 0) {
                    console.log('Primeira feature:', features[0]);
                    console.log('Primeira feature geometria:', features[0].geometry);
                }

                // Projeção já foi configurada no setupSVG(), não precisa ajustar aqui
                console.log('Usando projeção pré-configurada:', projection.scale(), projection.translate());

                // Criar grupo para o mapa
                const mapGroup = g.append('g').attr('class', 'map-group');

                // Desenhar estados
                const states = mapGroup.selectAll('.brazil-state')
                    .data(features)
                    .enter()
                    .append('path')
                    .attr('class', 'brazil-state')
                    .attr('d', path)
                    .attr('fill', d => { // Preenchimento inicial com a cor do cluster
                        const stateName = d.properties.NAME || d.properties.name;
                        const clusterId = getStateCluster(stateName);
                        return clusterId ? getClusterColor(clusterId) : '#011E38'; // Cor padrão
                    })
                    .attr('stroke', "#F5F1EB") // off-white
                    .attr('stroke-width', 1.5)
                    .attr('opacity', 0.95)
                    .on('mouseover', function(event, d) {
                        d3.select(this)
                            .attr('fill', '#FFBC82') // Realce ao passar o mouse
                            .attr('stroke', '#F5F1EB')
                            .attr('stroke-width', 2);
                            
                        const stateName = d.properties.NAME || d.properties.name || d.properties.NOME || d.properties.NM_ESTADO || 'Estado';
                        showTooltip(event, {
                            title: stateName,
                            data: {
                                'Estado': stateName,
                                'Região': getStateRegion(stateName),
                                'Código IBGE': d.properties.CODIBGE || d.properties.CD_GEOCUF || d.properties.id || 'N/A'
                            }
                        });
                    })
                    .on('mouseout', function(event, d) {
                        const stateName = d.properties.NAME || d.properties.name || d.properties.NOME || d.properties.NM_ESTADO;
                        const clusterId = getStateCluster(stateName);
                        const color = clusterId ? getClusterColor(clusterId) : '#011E38';
                        
                        d3.select(this)
                            .attr('fill', color) // Restaura a cor original
                            .attr('stroke', "#F5F1EB")
                            .attr('stroke-width', 1.5);
                        hideTooltip();
                    });

                console.log(`Mapa desenhado com ${features.length} estados`);
                
            } catch (error) {
                console.error('Erro ao desenhar mapa:', error);
                drawFallbackMap();
            }
        }

        // Função auxiliar para obter região do estado
        function getStateRegion(stateName) {
            const regions = {
                'Acre': 'Norte', 'Amazonas': 'Norte', 'Amapá': 'Norte', 'Pará': 'Norte', 
                'Rondônia': 'Norte', 'Roraima': 'Norte', 'Tocantins': 'Norte',
                'Alagoas': 'Nordeste', 'Bahia': 'Nordeste', 'Ceará': 'Nordeste', 
                'Maranhão': 'Nordeste', 'Paraíba': 'Nordeste', 'Pernambuco': 'Nordeste', 
                'Piauí': 'Nordeste', 'Rio Grande do Norte': 'Nordeste', 'Sergipe': 'Nordeste',
                'Distrito Federal': 'Centro-Oeste', 'Goiás': 'Centro-Oeste', 
                'Mato Grosso': 'Centro-Oeste', 'Mato Grosso do Sul': 'Centro-Oeste',
                'Espírito Santo': 'Sudeste', 'Minas Gerais': 'Sudeste', 
                'Rio de Janeiro': 'Sudeste', 'São Paulo': 'Sudeste',
                'Paraná': 'Sul', 'Rio Grande do Sul': 'Sul', 'Santa Catarina': 'Sul'
            };
            return regions[stateName] || 'Desconhecida';
        }

        // Função para obter cluster de um estado
        function getStateCluster(stateName) {
            const stateNode = nodesData.find(node => node.estado === stateName);
            return stateNode ? stateNode.cluster_id : null;
        }

        // Função para obter cor do cluster
        function getClusterColor(clusterId) {
            return CONFIG.clusters[clusterId]?.color || '#666666';
        }

        function drawFallbackMap() {
            console.log('Desenhando mapa fallback estilizado');
            
            // Limpar mapa existente para evitar duplicação
            g.selectAll('.map-group').remove();
            
            // Forma aproximada do Brasil usando path
            const brazilOutline = "M200,150 L350,120 L450,140 L520,180 L580,220 L600,280 L590,350 L570,420 L540,480 L500,520 L450,540 L400,550 L350,545 L300,530 L250,500 L220,460 L200,400 L190,350 L195,300 L200,250 Z";
            
            const mapGroup = g.append('g').attr('class', 'map-group');
            mapGroup.append('path')
                .attr('d', brazilOutline)
                .attr('fill', "none")
                .attr('stroke', "#F5F1EB") // off-white
                .attr('stroke-width', 2)
                .attr('transform', `translate(${(CONFIG.width - 600) / 2}, ${(CONFIG.height - 500) / 2}) scale(${Math.min(CONFIG.width / 800, CONFIG.height / 600)})`);
                
            g.append('text')
                .attr('x', CONFIG.width / 2)
                .attr('y', CONFIG.height / 2 + 50)
                .attr('text-anchor', 'middle')
                .attr('fill', "#FFBC82") // salmão
                .attr('font-size', '16px')
                .attr('font-weight', '600')
                .text('Mapa do Brasil (Carregando...)');
                
            g.append('text')
                .attr('x', CONFIG.width / 2)
                .attr('y', CONFIG.height / 2 + 75)
                .attr('text-anchor', 'middle')
                .attr('fill', "#666") // cinza
                .attr('font-size', '12px')
        }

        // === DESENHO DO GRAFO ===
        function drawGraph() {
            // Limpar grafo existente para evitar duplicação
            g.selectAll('.edge-group').remove();
            g.selectAll('.node-group').remove();
            
            drawEdges();
            drawNodes();
        }

        function drawEdges() {
            if (!showConnections) return;

            const filteredEdges = edgesData.filter(edge => {
                return edge.weight >= currentFilters.weight;
            });

            // Ordenar por intensidade para animação sequencial
            const sortedEdges = filteredEdges.sort((a, b) => b.weight - a.weight);

            const edgeGroup = g.selectAll('.edge-group')
                .data(sortedEdges, d => `${d.source}-${d.target}`);

            edgeGroup.exit().remove();

            const edgeEnter = edgeGroup.enter()
                .append('g')
                .attr('class', 'edge-group');

            // Criar linhas das conexões
            const lines = edgeEnter.append('line')
                .attr('class', d => {
                    let classes = 'state-edge';
                    if (d.corr_casos_simultaneos >= 0.8) classes += ' strong-correlation';
                    else if (d.corr_casos_simultaneos >= 0.6) classes += ' medium-correlation';
                    else classes += ' weak-correlation';
                    return classes;
                })
                .attr('stroke-width', d => Math.max(3, d.weight * 8))  // Linhas mais grossas para melhor visibilidade
                .attr('x1', d => {
                    const sourceNode = nodesData.find(n => n.estado === d.source);
                    return sourceNode ? projection([sourceNode.longitude, sourceNode.latitude])[0] : 0;
                })
                .attr('y1', d => {
                    const sourceNode = nodesData.find(n => n.estado === d.source);
                    return sourceNode ? projection([sourceNode.longitude, sourceNode.latitude])[1] : 0;
                })
                .attr('x2', d => {
                    const targetNode = nodesData.find(n => n.estado === d.target);
                    return targetNode ? projection([targetNode.longitude, targetNode.latitude])[0] : 0;
                })
                .attr('y2', d => {
                    const targetNode = nodesData.find(n => n.estado === d.target);
                    return targetNode ? projection([targetNode.longitude, targetNode.latitude])[1] : 0;
                })
                .attr("stroke", d => d.active ? "#FFBC82" : "#264FEC") // salmão se ativa, azul-royal se normal
                .attr("stroke-width", d => d.active ? 3.5 : 2.2)
                .attr("opacity", 0.85)
                .attr("marker-end", "url(#arrow)")
                .style("filter", d => d.active ? "drop-shadow(0 0 8px #FFBC82)" : "drop-shadow(0 0 4px #264FEC)")
                .on('mouseover', function(event, d) {
                    d3.select(this).classed('highlighted', true);
                    showTooltip(event, {
                        title: `${d.source} ↔ ${d.target}`,
                        data: {
                            'Tipo': getConnectionType(d.corr_casos_simultaneos),
                            'Correlação': `${(d.corr_casos_simultaneos * 100).toFixed(1)}%`,
                            'Peso da Conexão': d.weight.toFixed(2),
                            'Distância': `${d.distance_km} km`,
                            'Mesmo Cluster': d.cluster_match ? 'Sim' : 'Não',
                            'Impacto Epidemiológico': getEpidemiologicalImpact(d.weight, d.corr_casos_simultaneos)
                        }
                    });
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).classed('highlighted', false);
                    hideTooltip();
                })
                .on('click', function(event, d) {
                    triggerEpidemiologicalAnimation(d);
                });

            // Animação sequencial das conexões
            lines.each(function(d, i) {
                d3.select(this)
                    .style('animation-delay', `${i * 0.1}s`)
                    .classed('animated', true);
            });

            // Adicionar partículas viajantes para conexões fortes
            sortedEdges.forEach((edge, index) => {
                if (edge.corr_casos_simultaneos >= 0.7) {
                    setTimeout(() => {
                        createTravelingParticles(edge);
                    }, index * 200 + 1000); // Após as conexões crescerem
                }
            });
        }

        // Função para obter tipo de conexão
        function getConnectionType(correlation) {
            if (correlation >= 0.8) return 'Correlação Forte';
            if (correlation >= 0.6) return 'Correlação Moderada';
            return 'Correlação Fraca';
        }

        // Função para calcular impacto epidemiológico
        function getEpidemiologicalImpact(weight, correlation) {
            const impact = weight * correlation;
            if (impact >= 0.7) return 'Alto Risco de Propagação';
            if (impact >= 0.4) return 'Risco Moderado';
            return 'Baixo Risco';
        }

        function drawNodes() {
            if (!showNodes) return;

            const filteredNodes = nodesData.filter(node => {
                if (currentFilters.region !== 'all' && node.regiao !== currentFilters.region) {
                    return false;
                }
                return currentFilters.clusters.has(node.cluster_id);
            });

            const nodeGroup = g.selectAll('.node-group')
                .data(filteredNodes, d => d.estado);

            nodeGroup.exit().remove();

            const nodeEnter = nodeGroup.enter()
                .append('g')
                .attr('class', 'node-group')
                .attr('transform', d => {
                    const coords = projection([d.longitude, d.latitude]);
                    return `translate(${coords[0]}, ${coords[1]})`;
                });

            // Círculo do nó
            nodeEnter.append('circle')
                .attr('class', 'state-node')
                .attr('r', d => Math.max(6, Math.sqrt(d.casos_per_100k) / 15))  // Nós maiores para melhor visibilidade
                .attr('fill', d => CONFIG.clusters[d.cluster_id]?.color || '#999')
                .attr('stroke', '#fff')
                .attr('stroke-width', 1.5)
                .on('mouseover', function(event, d) {
                    highlightStateConnections(d.estado);
                    showTooltip(event, {
                        title: d.estado,
                        data: {
                            'Região': d.regiao,
                            'Casos/100k': d.casos_per_100k.toLocaleString('pt-BR'),
                            'Total Casos': d.casos_total.toLocaleString('pt-BR'),
                            'Total Óbitos': d.obitos_total.toLocaleString('pt-BR'),
                            'Cluster ML': `${d.cluster_id} - ${CONFIG.clusters[d.cluster_id]?.name}`,
                            'Workplace Avg': d.workplace_avg?.toFixed(1) || 'N/A',
                            'Stringency Avg': d.stringency_avg?.toFixed(1) || 'N/A'
                        }
                    });
                })
                .on('mouseout', function(event, d) {
                    clearHighlights();
                    hideTooltip();
                })
                .on('click', function(event, d) {
                    selectState(d.estado);
                    triggerEpidemiologicalPulse(d.estado);
                });

            // Rótulos dos estados
            if (showLabels) {
                nodeEnter.append('text')
                    .attr('class', 'state-label')
                    .attr('dy', -8)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('fill', '#fff')
                    .attr('stroke', '#000')
                    .attr('stroke-width', 0.5)
                    .text(d => d.estado);
            }
        }

        // === INTERATIVIDADE ===
        function highlightStateConnections(stateName) {
            // Destacar conexões do estado
            g.selectAll('.state-edge')
                .classed('highlighted', d => d.source === stateName || d.target === stateName);
        }

        function clearHighlights() {
            g.selectAll('.state-edge').classed('highlighted', false);
        }

        function selectState(stateName) {
            selectedState = selectedState === stateName ? null : stateName;
            
            // Atualizar visual dos nós
            g.selectAll('.state-node')
                .attr('stroke-width', d => d.estado === selectedState ? 3 : 1.5)
                .attr('stroke', d => d.estado === selectedState ? '#FFD700' : '#fff');

            if (selectedState) {
                highlightStateConnections(selectedState);
            } else {
                clearHighlights();
            }
        }

        // === TOOLTIP ===
        function showTooltip(event, data) {
            const tooltip = d3.select('#tooltip');
            
            let html = `<div class="tooltip-title">${data.title}</div>`;
            
            Object.entries(data.data).forEach(([key, value]) => {
                html += `<div class="tooltip-row"><span>${key}:</span><span>${value}</span></div>`;
            });
            
            tooltip.html(html)
                .style('display', 'block')
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            d3.select('#tooltip').style('display', 'none');
        }

        // === CONTROLES ===
        function setupControls() {
            console.log('Controles de sidebar removidos - layout simplificado para melhor visualização');
        }

        // === CONTROLES DO PAINEL LATERAL ===
        const timelineControls = document.getElementById('timeline-controls');
        const timelineToggle = document.getElementById('timeline-toggle');

        if (timelineToggle) {
            timelineToggle.addEventListener('click', () => {
                timelineControls.classList.toggle('open');
            });
        }

         // Controles simplificados - apenas interações básicas

        // === RESPONSIVIDADE ===
        window.addEventListener('resize', function() {
            CONFIG.width = window.innerWidth - 300;  // Largura menos legenda lateral
            CONFIG.height = window.innerHeight - 60;  // Altura total menos header
            
            if (svg) {
                svg.attr('width', window.innerWidth).attr('height', window.innerHeight - 60);
            }
            if (projection) {
                projection
                    .scale(Math.min(window.innerWidth, window.innerHeight - 60) * 1.33)
                    .translate([window.innerWidth * 0.59, (window.innerHeight - 60) / 2]);
            }
            if (g) {
                drawBrazilMap();
                drawGraph();
            }
        });

        // === ANIMAÇÕES EPIDEMIOLÓGICAS ===

        // Criar pulso epidemiológico a partir de um estado
        function triggerEpidemiologicalPulse(stateName) {
            const stateNode = nodesData.find(n => n.estado === stateName);
            if (!stateNode) return;

            const coords = projection([stateNode.longitude, stateNode.latitude]);
            
            // Criar ondas concêntricas
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    createPulseWave(coords[0], coords[1], stateNode.cluster_id);
                }, i * 500);
            }

            // Destacar conexões do estado com delay
            setTimeout(() => {
                highlightStateConnections(stateName);
                animateConnectedStates(stateName);
            }, 800);
        }

        // Criar onda de pulso
        function createPulseWave(x, y, clusterId) {
            const pulse = g.append('circle')
                .attr('class', 'epidemic-pulse')
                .attr('cx', x)
                .attr('cy', y)
                .attr('r', 5)
                .style('stroke', CONFIG.clusters[clusterId]?.color || '#FFBC82');

            // Remover o pulso após a animação
            setTimeout(() => {
                pulse.remove();
            }, 2000);
        }

        // Animar estados conectados
        function animateConnectedStates(stateName) {
            const connectedEdges = edgesData.filter(edge => 
                edge.source === stateName || edge.target === stateName
            );

            connectedEdges.forEach((edge, index) => {
                setTimeout(() => {
                    const targetState = edge.source === stateName ? edge.target : edge.source;
                    const targetNode = nodesData.find(n => n.estado === targetState);
                    
                    if (targetNode) {
                        const coords = projection([targetNode.longitude, targetNode.latitude]);
                        createPulseWave(coords[0], coords[1], targetNode.cluster_id);
                    }
                }, index * 300);
            });
        }

        // Criar partículas viajantes
        function createTravelingParticles(edge) {
            const sourceNode = nodesData.find(n => n.estado === edge.source);
            const targetNode = nodesData.find(n => n.estado === edge.target);
            
            if (!sourceNode || !targetNode) return;

            const sourceCoords = projection([sourceNode.longitude, sourceNode.latitude]);
            const targetCoords = projection([targetNode.longitude, targetNode.latitude]);

            // Número de partículas baseado na correlação
            const particleCount = Math.ceil(edge.corr_casos_simultaneos * 5);
            
            for (let i = 0; i < particleCount; i++) {
                setTimeout(() => {
                    createSingleParticle(sourceCoords, targetCoords, edge);
                }, i * 200);
            }
        }

        // Criar partícula individual com animação aprimorada
        function createSingleParticle(start, end, edge) {
            const duration = (1800 + Math.random() * 500) / edge.corr_casos_simultaneos;
            const radius = Math.max(2, edge.weight * 3) + (Math.random() - 0.5) * 2;

            const particle = g.append('circle')
                .attr('class', () => {
                    let classes = 'traveling-particle';
                    if (edge.corr_casos_simultaneos >= 0.8) classes += ' particle-strong';
                    else if (edge.corr_casos_simultaneos >= 0.6) classes += ' particle-medium';
                    else classes += ' particle-weak';
                    return classes;
                })
                .attr('cx', start[0])
                .attr('cy', start[1])
                .attr('r', radius)
                .style('opacity', 0);

            // Animar movimento e visibilidade da partícula
            particle.transition()
                .duration(duration * 0.2) // Fade in
                .style('opacity', 1)
                .transition()
                .duration(duration * 0.8) // Movimento
                .ease(d3.easeCubicInOut)
                .attr('cx', end[0])
                .attr('cy', end[1])
                .on('end', function() {
                    // Criar pequeno pulso no destino
                    createPulseWave(end[0], end[1], 
                        nodesData.find(n => n.estado === edge.target)?.cluster_id || 1);
                    
                    // Fade out e remoção da partícula
                    d3.select(this).transition()
                        .duration(300)
                        .style('opacity', 0)
                        .remove();
                });
        }

        // Animação de conexão epidemiológica completa com pulso na aresta
        function triggerEpidemiologicalAnimation(edge) {
            const sourceNode = nodesData.find(n => n.estado === edge.source);
            const targetNode = nodesData.find(n => n.estado === edge.target);
            
            if (!sourceNode || !targetNode) return;

            // Pulso no estado origem
            const sourceCoords = projection([sourceNode.longitude, sourceNode.latitude]);
            createPulseWave(sourceCoords[0], sourceCoords[1], sourceNode.cluster_id);

            // Encontrar e pulsar a aresta correspondente
            const edgeElement = g.selectAll('.state-edge')
                .filter(d => d && d.source === edge.source && d.target === edge.target)
                .raise(); // Traz a aresta para frente

            edgeElement.transition()
                .duration(250)
                .attr('stroke-width', d => getEpidemiologicalImpact(d.weight, d.corr_casos_simultaneos) * 2.5) // Engrossa
                .style('stroke-opacity', 1)
                .transition()
                .duration(500)
                .attr('stroke-width', d => getEpidemiologicalImpact(d.weight, d.corr_casos_simultaneos)) // Retorna ao normal
                .style('stroke-opacity', 0.6);

            // Partículas viajantes após delay
            setTimeout(() => {
                createTravelingParticles(edge);
            }, 300); // Delay menor para sincronizar com pulso

            // Remover destaque após animação (opcional, já que o pulso é o destaque)
            setTimeout(() => {
                g.selectAll('.state-edge.highlighted').classed('highlighted', false);
            }, 4000);
        }

        // Auto-play de animações epidemiológicas (opcional)
        function startEpidemiologicalSimulation() {
            if (!nodesData.length || !edgesData.length) return;

            // Começar com o estado com mais conexões
            const stateConnections = {};
            edgesData.forEach(edge => {
                stateConnections[edge.source] = (stateConnections[edge.source] || 0) + 1;
                stateConnections[edge.target] = (stateConnections[edge.target] || 0) + 1;
            });

            const epicenter = Object.keys(stateConnections)
                .reduce((a, b) => stateConnections[a] > stateConnections[b] ? a : b);

            console.log(`Iniciando simulação epidemiológica a partir de: ${epicenter}`);
            triggerEpidemiologicalPulse(epicenter);
        }

        // Função para limpar todas as animações
        function clearAllAnimations() {
            if (!g) return; // Verificar se g existe
            
            // Remover todas as partículas
            g.selectAll('.traveling-particle').remove();
            
            // Remover todos os pulsos
            g.selectAll('.epidemic-pulse').remove();
            
            // Remover destaques
            g.selectAll('.state-edge').classed('highlighted', false);
            g.selectAll('.state-node').classed('highlighted', false);
            
            console.log('Animações epidemiológicas limpas');
        }

        // === CONTROLES DE TIMELINE ===
        function setupTimelineControls() {
            const timelineSlider = document.getElementById('timeline-slider');
            const playBtn = document.getElementById('play-btn');
            const resetBtn = document.getElementById('reset-btn');
            const speedSelector = document.getElementById('speed-selector');
            const currentDateEl = document.getElementById('current-timeline-date');

            // Slider de timeline
            timelineSlider.addEventListener('input', function() {
                const step = parseInt(this.value);
                animationSettings.currentStep = step;
                updateTimelineStep(step);
                updateTimelineUI();
            });

            // Botão play/pause
            playBtn.addEventListener('click', function() {
                if (animationSettings.isPlaying) {
                    pauseTimeline();
                } else {
                    playTimeline();
                }
            });

            // Botão reset
            resetBtn.addEventListener('click', function() {
                resetTimeline();
            });

            // Seletor de velocidade
            speedSelector.addEventListener('change', function() {
                animationSettings.speed = parseInt(this.value);
                if (animationSettings.isPlaying) {
                    pauseTimeline();
                    playTimeline();
                }
            });

            // Inicializar no primeiro step
            updateTimelineStep(0);
            updateTimelineUI();
        }

        function playTimeline() {
            if (animationSettings.isPlaying) return;
            
            animationSettings.isPlaying = true;
            const playBtn = document.getElementById('play-btn');
            playBtn.innerHTML = '⏸ Pause';
            playBtn.classList.add('playing');

            animationSettings.playbackInterval = setInterval(() => {
                if (animationSettings.currentStep >= animationSettings.totalSteps - 1) {
                    pauseTimeline();
                    return;
                }

                animationSettings.currentStep++;
                updateTimelineStep(animationSettings.currentStep);
                updateTimelineUI();
            }, animationSettings.speed);
        }

        function pauseTimeline() {
            animationSettings.isPlaying = false;
            const playBtn = document.getElementById('play-btn');
            playBtn.innerHTML = '▶ Play';
            playBtn.classList.remove('playing');

            if (animationSettings.playbackInterval) {
                clearInterval(animationSettings.playbackInterval);
                animationSettings.playbackInterval = null;
            }
        }

        function resetTimeline() {
            pauseTimeline();
            animationSettings.currentStep = 0;
            updateTimelineStep(0);
            updateTimelineUI();
            clearAllAnimations();
        }

        function updateTimelineUI() {
            const timelineSlider = document.getElementById('timeline-slider');
            const currentDateEl = document.getElementById('current-timeline-date');
            
            if (!timelineSlider || !currentDateEl) return;

            const step = animationSettings.currentStep;

            // Atualizar valor do slider
            timelineSlider.value = step;

            // Atualizar texto da data
            if (TEMPORAL_DATA.months[step]) {
                currentDateEl.textContent = TEMPORAL_DATA.months[step].name;
            }
        }

        function updateTimelineStep(step) {
            const currentMonth = TEMPORAL_DATA.months[step];
            if (!currentMonth) return;

            console.log(`Timeline: ${currentMonth.name} - Intensidade: ${currentMonth.intensity}`);

            // Limpar animações anteriores
            clearAllAnimations();

            // Atualizar painel de informações do período
            updatePeriodInfo(currentMonth);

            // Atualizar intensidade global das conexões
            updateConnectionsIntensity(currentMonth.intensity);

            // Ativar epicentros do período
            activateEpicenters(currentMonth.epicenters, currentMonth.intensity);

            // Estatísticas removidas para interface mais limpa

            // Trigger animações baseadas na intensidade
            if (currentMonth.intensity > 0.3) {
                setTimeout(() => {
                    triggerPeriodAnimations(currentMonth);
                }, 500);
            }
        }



        function updateConnectionsIntensity(intensity) {
            // Filtrar conexões baseado na intensidade temporal
            const threshold = 1 - intensity; // Conforme intensidade aumenta, threshold diminui
            
            g.selectAll('.state-edge')
                .style('opacity', d => {
                    const edgeStrength = d.weight * d.corr_casos_simultaneos;
                    return edgeStrength >= threshold ? intensity * 0.8 : 0.1;
                })
                .style('stroke-width', d => {
                    const edgeStrength = d.weight * d.corr_casos_simultaneos;
                    return edgeStrength >= threshold ? d.weight * intensity * 6 : 1;
                });
        }

        function activateEpicenters(epicenters, intensity) {
            // Destacar nós que são epicentros no período
            g.selectAll('.state-node')
                .style('opacity', d => {
                    return epicenters.includes(d.estado) ? 1 : 0.3 + (intensity * 0.4);
                })
                .attr('r', d => {
                    const baseRadius = Math.max(6, Math.sqrt(d.casos_per_100k) / 15);
                    return epicenters.includes(d.estado) ? baseRadius * (1 + intensity) : baseRadius;
                })
                .style('stroke-width', d => {
                    return epicenters.includes(d.estado) ? 3 : 1.5;
                })
                .style('stroke', d => {
                    return epicenters.includes(d.estado) ? '#FFD700' : '#fff';
                });
        }

        function triggerPeriodAnimations(monthData) {
            // Criar pulsos epidemiológicos nos epicentros
            monthData.epicenters.forEach((stateName, index) => {
                setTimeout(() => {
                    triggerEpidemiologicalPulse(stateName);
                }, index * 300);
            });

            // Ativar partículas entre epicentros conectados
            if (monthData.intensity > 0.5) {
                setTimeout(() => {
                    const strongEdges = edgesData.filter(edge => {
                        return monthData.epicenters.includes(edge.source) && 
                               monthData.epicenters.includes(edge.target) &&
                               edge.corr_casos_simultaneos >= 0.6;
                    });
                    
                    strongEdges.forEach((edge, index) => {
                        setTimeout(() => {
                            createTravelingParticles(edge);
                        }, index * 200);
                    });
                }, 1000);
            }
        }


        function updatePeriodInfo(monthData) {
            const periodInfo = document.getElementById('period-info');
            const periodIcon = document.getElementById('period-icon');
            const periodTitleText = document.getElementById('period-title-text');
            const periodIntensityBadge = document.getElementById('period-intensity-badge');
            const periodBullets = document.getElementById('period-bullets');

            // Atualizar conteúdo
            periodIcon.textContent = monthData.icon;
            periodTitleText.textContent = monthData.title;
            periodIntensityBadge.textContent = `${Math.round(monthData.intensity * 100)}%`;

            // Limpar bullets anteriores
            periodBullets.innerHTML = '';

            // Adicionar novos bullets
            monthData.bullets.forEach((bullet, index) => {
                const li = document.createElement('li');
                li.className = 'period-bullet';
                li.innerHTML = `
                    <span class="bullet-icon">•</span>
                    <span class="bullet-text">${bullet}</span>
                `;
                li.style.animationDelay = `${(index + 1) * 0.1}s`;
                periodBullets.appendChild(li);
            });

            // Mostrar painel com animação
            setTimeout(() => {
                periodInfo.classList.add('show');
            }, 200);

            // Atualizar cor do badge baseado na intensidade
            const intensity = monthData.intensity;
            if (intensity < 0.3) {
                periodIntensityBadge.style.background = 'linear-gradient(90deg, #96CEB4 0%, #4ECDC4 100%)';
            } else if (intensity < 0.7) {
                periodIntensityBadge.style.background = 'linear-gradient(90deg, #FFEAA7 0%, #FFD700 100%)';
            } else {
                periodIntensityBadge.style.background = 'linear-gradient(90deg, #FF6B6B 0%, #FF4757 100%)';
            }
        }

        // Inicializar painel de informações
        function initializePeriodInfo() {
            const firstMonth = TEMPORAL_DATA.months[0];
            updatePeriodInfo(firstMonth);
        }

        // === CONTROLES DE LEGENDA ===
        function setupLegendToggle() {
            const legendPanel = document.getElementById('legend-panel');
            const legendToggle = document.getElementById('legend-toggle');
            
            if (legendToggle && legendPanel) {
                // Toggle da legenda
                legendToggle.addEventListener('click', function() {
                    legendPanel.classList.toggle('open');
                });
            }
        }

        // Iniciar simulação após carregamento completo
        setTimeout(() => {
            if (showConnections && nodesData.length > 0) {
                // Começar com o primeiro step da timeline ao invés da simulação automática
                updateTimelineStep(0);
                console.log('Timeline de evolução epidemiológica inicializada');
            }
        }, 3000);
    </script>
<script>
</script>
</body>
</html>